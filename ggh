#!/bin/bash
#
# ggh -- git-gerrit helper
#
#


show_usage () {
    echo '
ggh - git-gerrit helper

"ggh setup"  - Setup the git aliases listed below in your global git config.  Note, each git alias just calls through to ggh with the arguments passed in.  So ggh could be used directly without the git aliases.

Git Aliases

"git gerrit-clone <url>" ---> git clone <url>, then setup post-commit hook

"git start <local branch> <remote branch>" ---> git checkout -b $1 origin/$2

"git upload" ---> show summary of changes to be uploaded, approve, upload

"git prune" ----> remove all branches not ahead of the remote'

}

cmd_setup () {

    type -P ggh &>/dev/null || { echo "ggh must be in your PATH var in order to be setup." >&2; exit 1; }

    type -P git &>/dev/null || { echo "git must be in your PATH var in order to be setup." >&2; exit 1; }
    

}

cmd_gerrit_clone () {
    git clone $1
    project=`echo $1 | sed -E "s/.*\///"`
    gerrit=`echo $1 | sed -E "s/ssh:\/\/([^:\/]*).*/\1/"`
    scp $gerrit:hooks/commit-msg $project/.git/hooks
}

cmd_start () {
    git checkout -b $1 origin/$2
}

cmd_upload () {
    #check for clean status
    status=`git status -s`
    if [ -n "$status" ] 
    then
	echo "ggh error: Can not upload for review. Git status is not clean, please commit or stash changes and try again."
	exit 1
    fi

    local_branch=`git symbolic-ref HEAD | sed -e 's|^refs/heads/||'`
    remote_branch=`git config branch.$local_branch.merge | sed -e 's|^refs/heads/||'`

    if [ -z "$remote_branch" ]
    then
	echo "ggh error: This branch is not tracking a remote branch, upload not possible."
	exit 1
    fi

    #show preview
    git log --graph --stat origin/$remote_branch..
    
    #make user confirm upload
    echo
    echo -n "Are you sure you would like to upload these changes for review? [y/N]"
    read -n1 answer
    echo 
    
    if [ -z "$answer" ]
    then
	answer="n"
    fi

    # push if they said yes
    if [ $answer == "y" -o $answer == "Y" ]
    then
	git push origin HEAD:refs/for/$remote_branch
    else
	echo "Aborting upload."
    fi

}

cmd_prune () {
    echo fjdskl
}



case "$1" in
    setup)
	cmd_setup
	;;

    gerrit-clone)
	cmd_gerrit_clone $2
	;;

    start)
	cmd_start $2 $3
	;;

    upload)
	cmd_upload
	;;

    prune)
	cmd_prune
	;;

    *)
	show_usage
	;;

esac
